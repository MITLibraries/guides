
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Working with AWS &#8212; Guides  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Terraform" href="legacy-terraform.html" />
    <link rel="prev" title="Heroku Launch Checklist" href="heroku_checklist.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="working-with-aws">
<h1>Working with AWS<a class="headerlink" href="#working-with-aws" title="Permalink to this headline">¶</a></h1>
<p>This covers basic documentation for working with our AWS account.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You will have access to create AWS resources, but you should not do this unless you have been instructed to do so. Most of our infrastructure provisioning is automated through Terraform.</p>
</div>
<section id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>You will effectively have two different AWS accounts. The first is the account you will use to log into the web console. This account is integrated with Touchstone. To get access, ask in the #engineering channel. Someone with the correct permissions will need to log into <a class="reference external" href="https://groups.mit.edu/webmoira">https://groups.mit.edu/webmoira</a> and add the user to <code class="docutils literal notranslate"><span class="pre">the</span> <span class="pre">aws-672626379771-dev</span></code> list. This will give you access to the AWS console which can be accessed from <a class="reference external" href="https://aws.mit.edu">https://aws.mit.edu</a>.</p>
<p>The next thing you need to do is complete the account setup that you can use
to authenticate locally, either from the AWS CLI or through an AWS library like boto3. First,
confirm with InfraEng (or ask on the #engineering Slack channel) that your CLI account has been
added to our AWS organization (InfraEng handles this via Terraform). Then, log into the AWS console and follow these steps.</p>
<ol class="arabic simple">
<li><p>Under <code class="docutils literal notranslate"><span class="pre">Services</span></code> in the top bar search for “IAM” and click on that.</p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">Users</span></code>, search for your kerb, and then click on it.</p></li>
<li><p>Click on the <code class="docutils literal notranslate"><span class="pre">Security</span> <span class="pre">Credentials</span></code> tab.</p></li>
<li><p>Click on the <code class="docutils literal notranslate"><span class="pre">Create</span> <span class="pre">access</span> <span class="pre">key</span></code> button.</p></li>
<li><p>Make sure you copy the keys that it generates for you as this will be your only chance to do so.</p></li>
</ol>
</section>
<section id="creating-a-new-moira-based-role">
<h2>Creating a new Moira-based Role<a class="headerlink" href="#creating-a-new-moira-based-role" title="Permalink to this headline">¶</a></h2>
<p>In some cases we need to give non-developer library staff access to AWS resources directly. This is most commonly done when a user needs to be able to manage files in an S3 bucket. While we should strive to mediate access to AWS resources through applications, when the need arises, the way to do this is through a special moira list that’s integrated with Touchstone.</p>
<section id="setting-up-the-moira-list">
<h3>Setting up the Moira List<a class="headerlink" href="#setting-up-the-moira-list" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure to follow these instructions carefully as there is some IS&amp;T magic involved.</p>
</div>
<ol class="arabic simple">
<li><p>Go to <a class="reference external" href="https://groups.mit.edu/webmoira">https://groups.mit.edu/webmoira</a> and create a new moira (<em>not</em> mailman) list.</p></li>
<li><p>The name of the list must start with <code class="docutils literal notranslate"><span class="pre">aws-672626379771-</span></code>. For example, you could name it <code class="docutils literal notranslate"><span class="pre">aws-672626379771-gis-upload</span></code>.</p></li>
<li><p>The options at the bottom of the list creation page should look like this:</p></li>
</ol>
<blockquote>
<div><div class="line-block">
<div class="line">☐ Is this list public?</div>
<div class="line">☑ Is this list hidden?</div>
<div class="line">☐ Is this list a mailing list?</div>
<div class="line">☐ Is this list an AFS group?</div>
<div class="line">☐ Is this group for use on IS&amp;T’s NFS servers?</div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>Create the list.</p></li>
</ol>
</section>
<section id="creating-the-iam-role">
<h3>Creating the IAM Role<a class="headerlink" href="#creating-the-iam-role" title="Permalink to this headline">¶</a></h3>
<p>In order to use this new list in AWS you will need to create a special IAM Role for it. <em>This should be done through Terraform, not pointing and clicking in the web console.</em> The following shows the necessary Terraform:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="s2">&quot;aws_iam_policy_document&quot;</span> <span class="s2">&quot;saml_policy&quot;</span> <span class="p">{</span>
  <span class="n">statement</span> <span class="p">{</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sts:AssumeRoleWithSAML&quot;</span><span class="p">]</span>

    <span class="n">principals</span> <span class="p">{</span>
      <span class="nb">type</span>        <span class="o">=</span> <span class="s2">&quot;Federated&quot;</span>
      <span class="n">identifiers</span> <span class="o">=</span> <span class="p">[</span><span class="n">module</span><span class="o">.</span><span class="n">shared</span><span class="o">.</span><span class="n">mit_saml_arn</span><span class="p">]</span>
    <span class="p">}</span>

    <span class="n">condition</span> <span class="p">{</span>
      <span class="n">test</span>     <span class="o">=</span> <span class="s2">&quot;StringEquals&quot;</span>
      <span class="n">variable</span> <span class="o">=</span> <span class="s2">&quot;SAML:aud&quot;</span>
      <span class="n">values</span>   <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;https://signin.aws.amazon.com/saml&quot;</span><span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">resource</span> <span class="s2">&quot;aws_iam_role&quot;</span> <span class="s2">&quot;saml_role&quot;</span> <span class="p">{</span>
  <span class="n">name</span>               <span class="o">=</span> <span class="s2">&quot;IdP-&lt;some name&gt;&quot;</span>
  <span class="n">assume_role_policy</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">aws_iam_policy_document</span><span class="o">.</span><span class="n">saml_policy</span><span class="o">.</span><span class="n">json</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The name of the role needs to be the name of the moira list prefixed by <code class="docutils literal notranslate"><span class="pre">IdP-</span></code>. For example, if the moira list you created was called <code class="docutils literal notranslate"><span class="pre">aws-672626379771-foobar</span></code>, then the AWS role name should be <code class="docutils literal notranslate"><span class="pre">IdP-foobar</span></code>.</p>
<p>This new role can now be used as you would any other IAM role. Users on the moira list who need to access AWS should log in the same way everyone does, through <a class="reference external" href="https://aws.mit.edu">https://aws.mit.edu</a>. If they are on more than one of these special moria lists, they will be presented with the option to choose which role they want to log in as. You can only be logged in under one of these roles at a time.</p>
</section>
</section>
<section id="weird-things">
<h2>Weird Things<a class="headerlink" href="#weird-things" title="Permalink to this headline">¶</a></h2>
<p>Sometimes AWS is weird and frustrating. These things go here.</p>
<section id="rsa-4096-certs">
<h3>RSA 4096 Certs<a class="headerlink" href="#rsa-4096-certs" title="Permalink to this headline">¶</a></h3>
<p>Amazon’s Certificate Manager does not handle RSA 4096 certificates yet. If you have one of these it will need to be added to IAM. There is no way that I can find to do this through either Terraform or the web console. You’ll have to use the AWS CLI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws iam upload-server-certificate \
  --server-certificate-name &lt;hostname&gt; \
  --certificate-body file://&lt;your cert&gt;.crt \
  --certificate-chain file://&lt;your cert&gt;.chain.crt \
  --private-key file://&lt;your cert&gt;.key
</pre></div>
</div>
</section>
<section id="efs-mount-race-conditions">
<h3>EFS Mount Race Conditions<a class="headerlink" href="#efs-mount-race-conditions" title="Permalink to this headline">¶</a></h3>
<p>I have observed on multiple occasions problems with mounting newly created EFS mounts in EC2 instances. This seems more likely to happen with Terraform due to resources being provisioned all at once. My guess is the DNS for the new EFS mount has not propagated by the time the cloud-init script is run, where you would usually do the NFS mount.</p>
<p>There’s no obvious (easy) mitigation for this. The good news is since it appears to simply be a DNS propagation issue, this should only be a problem for a short period after the initial provisioning of the EFS mount. My suggestion is to check the logs for your cloud-init script if you are spinning up an EC2 instance at the same time you are creating the EFS mount. There should be an error in there if it can’t resolve the hostname for the mount.</p>
</section>
<section id="fargate-log-flushing">
<h3>Fargate Log Flushing<a class="headerlink" href="#fargate-log-flushing" title="Permalink to this headline">¶</a></h3>
<p>Sometimes logs in Fargate don’t get written, or are only partially written, to Cloudwatch. My own experience suggests the problem is that the logs are being discarded before being fully flushed to Cloudwatch. The fix, which I have found to be reliable, is to add a few seconds of sleep to your container after you have stopped the main process. You can see an example here: <a class="reference external" href="https://github.com/MITLibraries/workflow/blob/master/entrypoint.sh">https://github.com/MITLibraries/workflow/blob/master/entrypoint.sh</a>.</p>
</section>
<section id="s3-bucket-limit">
<h3>S3 Bucket Limit<a class="headerlink" href="#s3-bucket-limit" title="Permalink to this headline">¶</a></h3>
<p>There’s a limit to the number of buckets an account can have in S3. Rather than creating a bunch of buckets, partition a few buckets with predictable prefixes. We do not currently do this, but it’s a practice we should consider switching to, soon.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Guides</a></h1>








<h3>Navigation</h3>
<p><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../basics/a11y.html">Accessibility / a11y</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/github.html">GitHub</a></li>
</ul>
<p><span class="caption-text">How We Work Together</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../collaboration/pairing.html">Pair programming</a></li>
</ul>
<p><span class="caption-text">Languages and Frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../languages/python.html">Python Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/rails.html">Rails at MIT Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/vuejs.html">Vue.js at MIT Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/wordpress.html">WordPress at MIT Libraries</a></li>
</ul>
<p><span class="caption-text">Authentication</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../authentication/oauth.html">OAuth at MIT (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authentication/touchstone_saml.html">Touchstone / Shibboleth / SAML</a></li>
</ul>
<p><span class="caption-text">Deployment</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="airflow.html">Airflow: workflow engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-2.0.html">AWS Organization</a></li>
<li class="toctree-l1"><a class="reference internal" href="cicd.html">Continuous Integration/Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="heroku.html">Heroku</a></li>
<li class="toctree-l1"><a class="reference internal" href="heroku_checklist.html">Heroku Launch Checklist</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Working with AWS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#creating-a-new-moira-based-role">Creating a new Moira-based Role</a></li>
<li class="toctree-l2"><a class="reference internal" href="#weird-things">Weird Things</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="legacy-terraform.html">Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="pantheon.html">Pantheon</a></li>
<li class="toctree-l1"><a class="reference internal" href="terraform-1.0.html">Terraform</a></li>
</ul>
<p><span class="caption-text">Everything else</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/docker.html">Containerizing Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/exception_monitoring.html">Exception Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/incident_response.html">Incident Response Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/logging.html">Central Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/matomo.html">Configuring Matomo for analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/proxy_urls.html">Proxy URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/ssl.html">SSL Encryption</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="heroku_checklist.html" title="previous chapter">Heroku Launch Checklist</a></li>
      <li>Next: <a href="legacy-terraform.html" title="next chapter">Terraform</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, MIT Libraries.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/deploy/legacy-aws.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>