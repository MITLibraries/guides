
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Continuous Integration/Deployment &#8212; Guides  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Heroku" href="heroku.html" />
    <link rel="prev" title="AWS Organization" href="aws-2.0.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="continuous-integration-deployment">
<h1>Continuous Integration/Deployment<a class="headerlink" href="#continuous-integration-deployment" title="Permalink to this headline">¶</a></h1>
<p>Your first choice for CI/CD should be Github Actions. If you are having trouble getting this to work, please ask in the #engineering Slack channel.</p>
<aside class="sidebar">
<p class="sidebar-title">Heroku Deploys</p>
<p>If your application is being deployed to Heroku, you should just be using Heroku Pipelines, not Github Actions.</p>
</aside>
<p>This guide will provide an overview of how the deployment process should generally work, with specific examples for the more common cases.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Most applications will have specific needs that may differ from other applications, but the general process for testing and deployment should follow the form:</p>
<ol class="arabic simple">
<li><p>Run tests when pushing commits.</p></li>
<li><p>Deploy staging build when merging PR onto master branch.</p></li>
<li><p>Deploy production build when a release is created.</p></li>
</ol>
<p>The act of creating a release in Github is how you decide when to deploy a new production instance. The most recent release should always be the code that’s running in production.</p>
</section>
<section id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<aside class="sidebar">
<p class="sidebar-title">Language specific examples</p>
<ul class="simple">
<li><p><a class="reference external" href="../languages/rails.html#continuous-integration">CI for Rails at MIT Libraries</a></p></li>
</ul>
</aside>
<p>The testing action will likely vary from project to project, so your best bet will be to look at examples of what other projects have done and ask in #engineering if you are having trouble. As a general rule your testing action should run on every push. This can be accomplished by setting:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">on</span><span class="p">:</span> <span class="n">push</span>
</pre></div>
</div>
<p>in your <code class="docutils literal notranslate"><span class="pre">.github/workflows/test.yml</span></code> file.</p>
</section>
<section id="aws-2-0-fargate-lambda-deployment">
<h2>AWS 2.0 Fargate/Lambda Deployment<a class="headerlink" href="#aws-2-0-fargate-lambda-deployment" title="Permalink to this headline">¶</a></h2>
<p>With the migration to our AWS Organization (see <cite>AWS 2.0 &lt;./aws-2.0&gt;</cite>), we have simplified and automated the container deployment process.</p>
<ol class="arabic simple">
<li><p>For both Lambda functions and ECS tasks/services, we make use of the AWS ECR container repositories. These are fully managed by the <cite>mitlib-tf-workloads-ecr &lt;https://github.com/mitlibraries/mitlib-tf-workloads-ecr&gt;`</cite> repository. The repo not only creates the ECR repository, it also generates the Makefile for the associated repo that builds the container as well as the GitHub Actions workflows for pushing containers to dev, stage, and prod AWS Accounts.</p></li>
<li><p>Once an Infra engineer has deployed the ECR repository, some copy/paste from the Terraform outputs will setup the Makefile and GitHub Actions workflows for the container repo.</p></li>
<li><p>The automation follows our standard practice that (a) PRs to the <cite>main</cite> branch will push an updated container to the dev AWS Account, (b) merges to <cite>main</cite> will push an updated container to the stage AWS Account, and (c) a tagged release on <cite>main</cite> will copy the container from the stage to the prod AWS Account.</p></li>
</ol>
<p>The section below is only necessary for applications that are not yet migrated to the new AWS Organization.</p>
</section>
<section id="legacy-aws-fargate-deployment">
<h2>Legacy AWS Fargate Deployment<a class="headerlink" href="#legacy-aws-fargate-deployment" title="Permalink to this headline">¶</a></h2>
<p>Most of our AWS deployments target Fargate. The staging and production deploys should look more or less the same. There is a yaml template (<a class="reference download internal" download="" href="../_downloads/ba311a13e55163995ec339e8702b33fe/deploy.yml"><code class="xref download docutils literal notranslate"><span class="pre">deploy.yml</span></code></a>) that can be used for both, with only a few changes you will need to make. To use this template, do the following:</p>
<ol class="arabic">
<li><p>Make two copies of the template, one called <code class="docutils literal notranslate"><span class="pre">.github/workflows/stage.yml</span></code> and one called <code class="docutils literal notranslate"><span class="pre">.github/workflows/prod.yml</span></code>.</p></li>
<li><p>Set the top level <code class="docutils literal notranslate"><span class="pre">name</span></code> key in each file to something more descriptive, like “Deploy staging build” and “Deploy production release”.</p></li>
<li><p>For the <code class="docutils literal notranslate"><span class="pre">stage.yml</span></code> file change the <code class="docutils literal notranslate"><span class="pre">on</span></code> key to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">on</span><span class="p">:</span>
  <span class="n">push</span><span class="p">:</span>
    <span class="n">branches</span><span class="p">:</span> <span class="p">[</span><span class="n">master</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>And for the <code class="docutils literal notranslate"><span class="pre">prod.yml</span></code> file change the <code class="docutils literal notranslate"><span class="pre">on</span></code> key to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">on</span><span class="p">:</span>
  <span class="n">release</span><span class="p">:</span>
    <span class="n">types</span><span class="p">:</span> <span class="p">[</span><span class="n">published</span><span class="p">]</span>
</pre></div>
</div>
</div></blockquote>
<ol class="arabic simple" start="4">
<li><p>In the template, under the <code class="docutils literal notranslate"><span class="pre">env</span></code> section, set the <code class="docutils literal notranslate"><span class="pre">IMAGE</span></code>, <code class="docutils literal notranslate"><span class="pre">CLUSTER</span></code> and <code class="docutils literal notranslate"><span class="pre">SERVICE</span></code> to the values given to you by the infrastructure team.</p></li>
<li><p>You will need a set of keys for a deploy user that has permission to upload images to ECR and redeploy the ECS service (ask in #engineering if you have not been given these). These should be set as secrets through the Github UI for the repo.</p></li>
</ol>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Guides</a></h1>








<h3>Navigation</h3>
<p><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../basics/a11y.html">Accessibility / a11y</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/github.html">GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/github_desktop.html">GitHub Desktop</a></li>
</ul>
<p><span class="caption-text">How We Work Together</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../collaboration/code_review.html">Code review</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collaboration/pairing.html">Pair programming</a></li>
</ul>
<p><span class="caption-text">Languages and Frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../languages/python.html">Python Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/rails.html">Rails at MIT Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/vuejs.html">Vue.js at MIT Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/wordpress.html">WordPress at MIT Libraries</a></li>
</ul>
<p><span class="caption-text">Authentication</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../authentication/oauth.html">OAuth at MIT (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authentication/touchstone_saml.html">Touchstone / Shibboleth / SAML</a></li>
</ul>
<p><span class="caption-text">Deployment</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="airflow.html">Airflow: workflow engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws-2.0.html">AWS Organization</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Continuous Integration/Deployment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing">Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#aws-2-0-fargate-lambda-deployment">AWS 2.0 Fargate/Lambda Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#legacy-aws-fargate-deployment">Legacy AWS Fargate Deployment</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="heroku.html">Heroku</a></li>
<li class="toctree-l1"><a class="reference internal" href="heroku_checklist.html">Heroku Launch Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="legacy-aws.html">Legacy AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="legacy-terraform.html">Legacy Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="pantheon.html">Pantheon</a></li>
<li class="toctree-l1"><a class="reference internal" href="terraform-1.0.html">Terraform</a></li>
</ul>
<p><span class="caption-text">Everything else</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/adr.html">Architecture Decision Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/docker.html">Containerizing Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/exception_monitoring.html">Exception Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/incident_response.html">Incident Response Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/logging.html">Central Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/matomo.html">Configuring apps to use Matomo for analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/proxy_urls.html">Proxy URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/ssl.html">SSL Encryption</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="aws-2.0.html" title="previous chapter">AWS Organization</a></li>
      <li>Next: <a href="heroku.html" title="next chapter">Heroku</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, MIT Libraries.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/deploy/cicd.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>