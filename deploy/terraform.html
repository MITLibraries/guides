
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Terraform &#8212; Guides  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Containerizing Your App" href="../misc/docker.html" />
    <link rel="prev" title="Pantheon" href="pantheon.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="terraform">
<h1>Terraform<a class="headerlink" href="#terraform" title="Permalink to this headline">¶</a></h1>
<p>This contains most of the documentation for how we use Terraform here. The primary repository is located at <a class="reference external" href="https://github.com/MITLibraries/mitlib-terraform">https://github.com/MITLibraries/mitlib-terraform</a> but there are other repos in the org that provide modules.</p>
<div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<div class="sidebar">
<p class="sidebar-title">TF 0.11</p>
<p>You may need to also maintain a version of 0.11 until we finish upgrading all our config to 0.12. There are only a few configs left, so there’s a good chance you won’t need it.</p>
</div>
<p>For all new TF work you should be using version 0.12. We make heavy use of workspaces to manage deploying to different environments. The first thing you should do is set the <code class="docutils literal notranslate"><span class="pre">TF_WORKSPACE</span></code> environment variable to <code class="docutils literal notranslate"><span class="pre">stage</span></code>. You should make this change persistent in whatever way you manage environment variables on your system. The easiest way to do this is to add the following to your <code class="docutils literal notranslate"><span class="pre">~/.bashrc</span></code> file (if you use bash):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">TF_WORKSPACE</span><span class="o">=</span><span class="n">stage</span>
</pre></div>
</div>
<p>However you choose to do this, <em>it should be the first thing you do.</em> Making this change will ensure you aren’t accidentally deploying to production.</p>
</div>
<div class="section" id="workspaces">
<h2>Workspaces<a class="headerlink" href="#workspaces" title="Permalink to this headline">¶</a></h2>
<p>We use <code class="docutils literal notranslate"><span class="pre">stage</span></code> and <code class="docutils literal notranslate"><span class="pre">prod</span></code> workspaces. If you have followed the instructions you should be deploying to the staging workspace by default. You can simply run <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">plan</span></code> and <code class="docutils literal notranslate"><span class="pre">terraform</span> <span class="pre">apply</span></code> and it will deploy to staging.</p>
<p>When you are ready to deploy to production you will need to explicitly specify the <code class="docutils literal notranslate"><span class="pre">prod</span></code> workspace. Rather than changing the <code class="docutils literal notranslate"><span class="pre">TF_WORKSPACE</span></code> envvar for your entire session, the recommended practice is to change it only for the command you are running. This may vary depending on which shell you are using. For bash, you would do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ TF_WORKSPACE=prod terraform plan
</pre></div>
</div>
<p>Doing things this way keeps it explicit about deploying to production.</p>
</div>
<div class="section" id="modules">
<h2>Modules<a class="headerlink" href="#modules" title="Permalink to this headline">¶</a></h2>
<p>Our current TF config uses quite a few external modules. This is a decision that has not aged well. TF modules are an acceptable solution, but the advice given in <a class="reference external" href="https://www.terraform.io/docs/modules/index.html#when-to-write-a-module">the Terraform documentation</a> should be followed. In general, if you are just wrapping a handful of AWS resources, don’t use a module; it’s better to just copy and paste. If you are using an external module make sure you are linking to a specific release and not just the master branch.</p>
</div>
<div class="section" id="variables">
<h2>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h2>
<p>If there are differences between staging and production, or you have secrets that need to be included, you should use TF variables. Include <code class="docutils literal notranslate"><span class="pre">prod.tfvars</span></code> and <code class="docutils literal notranslate"><span class="pre">stage.tfvars</span></code> files in your config. These should not be checked into version control. The main repo is currently set to ignore all <code class="docutils literal notranslate"><span class="pre">.tfvars</span></code> files.</p>
<p>We don’t have a great solution for sharing these variables yet. Until a better solution can be set up, you will need to manually sync these variables to the <code class="docutils literal notranslate"><span class="pre">mit-tfvars</span></code> S3 bucket. The structure of this bucket should mimic the structure of the main repo.</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Guides</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../basics/a11y.html">Accessibility / a11y</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/github.html">GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Languages and Frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../languages/python.html">Python Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/rails.html">Rails at MIT Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/wordpress.html">WordPress at MIT Libraries</a></li>
</ul>
<p class="caption"><span class="caption-text">Authentication</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../authentication/oauth.html">OAuth at MIT (deprecated)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../authentication/touchstone_saml.html">Touchstone / Shibboleth / SAML</a></li>
</ul>
<p class="caption"><span class="caption-text">Deployment</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="airflow.html">Airflow: workflow engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="aws.html">Working with AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="cicd.html">Continuous Integration/Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="heroku.html">Heroku</a></li>
<li class="toctree-l1"><a class="reference internal" href="pantheon.html">Pantheon</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Terraform</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#workspaces">Workspaces</a></li>
<li class="toctree-l2"><a class="reference internal" href="#modules">Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="#variables">Variables</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Everything else</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/docker.html">Containerizing Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/exception_monitoring.html">Exception Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/incident_response.html">Incident Response Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/logging.html">Central Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/proxy_urls.html">Proxy URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/ssl.html">SSL Encryption</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="pantheon.html" title="previous chapter">Pantheon</a></li>
      <li>Next: <a href="../misc/docker.html" title="next chapter">Containerizing Your App</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, MIT Libraries.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/deploy/terraform.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>