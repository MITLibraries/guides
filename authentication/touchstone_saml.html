
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Touchstone / Shibboleth / SAML &#8212; Guides  documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Airflow: workflow engine" href="../deploy/airflow.html" />
    <link rel="prev" title="OAuth at MIT (deprecated)" href="oauth.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="touchstone-shibboleth-saml">
<h1>Touchstone / Shibboleth / SAML<a class="headerlink" href="#touchstone-shibboleth-saml" title="Permalink to this headline">¶</a></h1>
<section id="what-is-touchstone">
<h2>What is Touchstone?<a class="headerlink" href="#what-is-touchstone" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://ist.mit.edu/touchstone-detail">Touchstone at MIT</a></p>
<p>Touchstone is MIT’s Shibboleth implementation that includes DUO for two factor
authentication.</p>
</section>
<section id="what-is-shibboleth">
<h2>What is Shibboleth?<a class="headerlink" href="#what-is-shibboleth" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Shibboleth_(Shibboleth_Consortium)">Shibboleth wikipedia entry</a></p>
</section>
<section id="what-is-saml">
<h2>What is SAML?<a class="headerlink" href="#what-is-saml" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Security_Assertion_Markup_Language">Security Assertion Markup Language</a></p>
</section>
<section id="what-are-we-doing-here">
<h2>What are we doing here?<a class="headerlink" href="#what-are-we-doing-here" title="Permalink to this headline">¶</a></h2>
<p>We want to use Touchstone, and thus Shibboleth, but without the <code class="docutils literal notranslate"><span class="pre">mod_shib</span></code>
Apache HTTPd plugin. We can do this by utilizing the SAML protocol that
the Touchstone server supports.</p>
<p><code class="docutils literal notranslate"><span class="pre">mod_shib</span></code> traditionally is the Shibboleth SP (service provider). We’ll be
implementing an SP in our application. The Touchstone service that MIT provides
is the Shibboleth IdP (identity provider).</p>
<p>There are some open source <a class="reference external" href="https://github.com/onelogin">support libraries for many languages</a>
that will make this fairly easy.</p>
<p>This initial documentation will focus on using
<a class="reference external" href="https://github.com/onelogin/ruby-saml">ruby-saml</a> with
<a class="reference external" href="https://github.com/omniauth/omniauth-saml">omniauth-saml</a> and
<a class="reference external" href="https://github.com/plataformatec/devise">devise</a> for a standard Rails
application the principles should hold with other languages.</p>
<p>A sample barebones functioning <a class="reference external" href="https://github.com/MITLibraries/rails_saml_example">rails application is available</a>.</p>
<p>We also have at least one <a class="reference external" href="https://github.com/MITLibraries/ebooks">Python/Flask app using Touchstone</a>
running in production, in case that’s helpful for setting up future
Python projects.</p>
</section>
<section id="registering-a-saml-sp-in-mit-touchstone">
<h2>Registering a SAML SP in MIT Touchstone<a class="headerlink" href="#registering-a-saml-sp-in-mit-touchstone" title="Permalink to this headline">¶</a></h2>
<p>The request itself is simple, but preparing your application for <em>successful</em>
submission takes some understanding of what is happening and providing what IST
needs in a way they can easily consume it. This is not hard, but it is
confusing and opaque. Please ask for help in Slack if you find yourself thinking it
would be easier to just <code class="docutils literal notranslate"><span class="pre">mod_shib</span></code> on a VM and make this someone else’s problem.</p>
<section id="request-dns-registration">
<h3>Request DNS registration<a class="headerlink" href="#request-dns-registration" title="Permalink to this headline">¶</a></h3>
<p>IS&amp;T TouchStone support prefers a <code class="docutils literal notranslate"><span class="pre">*.mit.edu</span></code> domain for each Touchstone
protected application. The easiest path to that is to just request DNS
registration for both staging and production environments.</p>
<p>note: Local development, automated tests, and PR builds should use
non-Touchstone authentication and thus don’t require <code class="docutils literal notranslate"><span class="pre">*.mit.edu</span></code> or Touchstone
registrations.</p>
</section>
<section id="generating-a-self-signed-certificate-for-touchstone">
<h3>Generating a self-signed certificate for Touchstone<a class="headerlink" href="#generating-a-self-signed-certificate-for-touchstone" title="Permalink to this headline">¶</a></h3>
<p>Touchstone support requests a long lived self signed certificate. The following
command will give you a 10 year cert with no password which is useful for
production environments where entering a password is non-ideal. If the private
key is compromised in any way, generate a new one and inform Touchstone support.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">openssl</span> <span class="n">req</span> <span class="o">-</span><span class="n">new</span> <span class="o">-</span><span class="n">x509</span> <span class="o">-</span><span class="n">nodes</span> <span class="o">-</span><span class="n">newkey</span> <span class="n">rsa</span><span class="p">:</span><span class="mi">2048</span> <span class="o">-</span><span class="n">keyout</span> <span class="n">APP_KEY</span><span class="o">.</span><span class="n">pem</span> <span class="o">-</span><span class="n">days</span> <span class="mi">3650</span> <span class="o">-</span><span class="n">out</span> <span class="n">APP_CERT</span><span class="o">.</span><span class="n">pem</span>
</pre></div>
</div>
<p>Suggestions for the prompts:</p>
<ul class="simple">
<li><p>US</p></li>
<li><p>Massachusetts</p></li>
<li><p>Cambridge</p></li>
<li><p>MIT</p></li>
<li><p>MIT Libraries</p></li>
<li><p>APP_NAME.mit.edu</p></li>
<li><p>lib-touchstone&#64;mit.edu [if you use this, make sure you are on the moira list]</p></li>
</ul>
</section>
<section id="configuring-the-application">
<h3>Configuring the application<a class="headerlink" href="#configuring-the-application" title="Permalink to this headline">¶</a></h3>
<p>Regardless which language or library you are using, there are a few pieces of
information you will need that should be the same for all apps:</p>
<ul class="simple">
<li><p>The IdP metadata URL is https://touchstone.mit.edu/metadata/MIT-metadata.xml</p></li>
<li><p>The IdP entity ID is https://idp.mit.edu/shibboleth</p></li>
<li><p>The IdP SSO URL is https://idp.mit.edu/idp/profile/SAML2/Redirect/SSO</p></li>
</ul>
<p><strong>NOTE:</strong> IST has moved to providing multiple IdP signing certs via <code class="docutils literal notranslate"><span class="pre">idp_cert_multi</span></code>
rather than just one via <code class="docutils literal notranslate"><span class="pre">idp_cert</span></code>. It is recommended that if you dynamically
pull this metadata (which is in general a good idea) rather than pulling it once
manually and configuring your SP directly, that you ensure you check for certs
in both locations in case IST is inconsistent with which they use in the future.
<a class="reference external" href="https://github.com/MITLibraries/thing/pull/570">While adjusting thing to support multiple certs</a>,
we temporarily pulled dyamically from the alternate metadata URL of
https://touchstone.mit.edu/metadata/idp.mit.edu-metadata.xml which at this time
only provides a single cert via <code class="docutils literal notranslate"><span class="pre">idp_cert</span></code>. IST stated that method of obtaining
the metadata would not move to using multiple certs, but it feels safest to just
assume they might toggle between either method with no notice.</p>
<section id="rails">
<h4>Rails<a class="headerlink" href="#rails" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>follow omniauth-saml instructions (which follow Facebook instructions)</p>
<ul>
<li><p>add gem and bundle</p></li>
<li><p>run migrations</p></li>
</ul>
</li>
<li><p>in devise.rb do something like:</p></li>
</ul>
<p><a class="reference external" href="https://github.com/MITLibraries/rails_saml_example/blob/master/config/initializers/devise.rb#L278-L302">sample app config</a></p>
</section>
<section id="python-flask">
<h4>Python/Flask<a class="headerlink" href="#python-flask" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Follow instructions to use <a class="reference external" href="https://github.com/onelogin/python3-saml">OneLogin’s SAML Python3 Toolkit</a></p></li>
<li><p>The ebooks example sets SAML configuration using env variables to populate
the python3-saml settings.json file. See <a class="reference external" href="https://github.com/MITLibraries/ebooks/blob/4c671f6aeae8a3b6fec74ba7b8942eb0fb35d2b9/ebooks/auth.py#L11">here</a> for example. Note that the
settings used here are the minimum required ones for MIT Touchstone auth to work.</p></li>
</ul>
</section>
</section>
<section id="generating-application-metadata">
<h3>Generating application metadata<a class="headerlink" href="#generating-application-metadata" title="Permalink to this headline">¶</a></h3>
<p>Touchstone registers the application by consuming metadata that the SP
generates.</p>
<p><code class="docutils literal notranslate"><span class="pre">ruby-saml</span></code> can provide this metadata on a devise configured application at <code class="docutils literal notranslate"><span class="pre">/users/auth/saml/metadata</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">python3-saml</span></code> will similarly provide this metadata at whatever route is set in
the view. Note it does not do this automagically like <code class="docutils literal notranslate"><span class="pre">ruby-saml</span></code>, you will need
to write the view yourself…but the example given in the <code class="docutils literal notranslate"><span class="pre">python3-saml</span></code> demo
app works fine, and is used in <a class="reference external" href="https://github.com/MITLibraries/ebooks/blob/4c671f6aeae8a3b6fec74ba7b8942eb0fb35d2b9/ebooks/views.py#L43_">ebooks</a>.</p>
<p>Once you deploy your application and the DNS is working, you will provide that
URL to IST and they will have everything they need in one place to register the
application. NOTE: they do not regularly poll the SP metadata so if you make
configuration or code changes that change the SP metadata, you need to ask
touchstone support to re-ingest the metadata.</p>
<section id="testshib">
<h4>testshib<a class="headerlink" href="#testshib" title="Permalink to this headline">¶</a></h4>
<p>I found it frustrating to configure a SAML application against MIT Touchstone with the information they provide which is all Shibboleth specific. However,
<a class="reference external" href="http://www.testshib.org">testshib.org</a> allows you to register your SP against
a test IdP and instantly see the results and error logs (you will have error
logs).</p>
<p>If testshib is not working (which happens sometimes), <a class="reference external" href="https://developers.onelogin.com/saml/python">OneLogin has good instructions</a>
for setting up a test IDP that you can use to ensure your app functions as a
SAML SP before attempting to register/configure it with MIT Touchstone.</p>
<p>If you <a class="reference external" href="https://12factor.net">12 factor your app</a>, changing from the testshib
IdP to the MIT Touchstone IdP later will be simple.</p>
<p>However, you need to be able to redirect back to your application from testshib
or OneLogin’s test IDP for authentication to succeed. I found <code class="docutils literal notranslate"><span class="pre">ngrok</span></code> to be
super helpful for that.</p>
</section>
<section id="ngrok">
<h4>ngrok<a class="headerlink" href="#ngrok" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="https://ngrok.com">ngrok</a></p>
<p>This allows you to spin up a publicly accessible endpoint with a secure tunnel
back to your localhost. So if I run my rails app on port 5000, I’d run
<code class="docutils literal notranslate"><span class="pre">ngrok</span> <span class="pre">http</span> <span class="pre">5000</span></code> to tunnel my port 5000 to an ngrok endpoint and then start my
local server on port 5000.</p>
<p>Note: every time you start ngrok you get a new endpoint. This means you will
need to re-upload your SP metadata to testshib. This is only a minor
inconvenience as the change takes place instantly.</p>
</section>
<section id="sp-metadata">
<h4>SP Metadata<a class="headerlink" href="#sp-metadata" title="Permalink to this headline">¶</a></h4>
<p>Once you have ngrok running you can export your SP metadata and upload it to
testshib.</p>
<p>You can then test authentication and debug any issues.</p>
</section>
</section>
<section id="email-touchstone-help">
<h3>Email Touchstone help<a class="headerlink" href="#email-touchstone-help" title="Permalink to this headline">¶</a></h3>
<p>Once you’ve confirmed you have your SP working with the testshib IdP, you can
push your code to wherever it will run (Heroku, a container somewhere, etc).
It should be using the DNS entry you will be registering with Touchstone at this
time as well.</p>
<p>Access the metadata at <code class="docutils literal notranslate"><span class="pre">FQDN/users/auth/saml/metadata</span></code> or whatever your SAML
metadata route is and confirm it looks reasonable.</p>
<p>Send an email to <code class="docutils literal notranslate"><span class="pre">touchstone-support&#64;mit.edu</span></code> with the following information:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">I</span> <span class="n">would</span> <span class="n">like</span> <span class="n">to</span> <span class="n">register</span> <span class="n">the</span> <span class="n">following</span> <span class="n">SAML</span> <span class="n">SP</span> <span class="k">with</span> <span class="n">Touchstone</span><span class="o">.</span>

<span class="n">SP</span> <span class="n">Metadata</span> <span class="n">URL</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">YOUR_APP</span><span class="o">.</span><span class="n">mit</span><span class="o">.</span><span class="n">edu</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">auth</span><span class="o">/</span><span class="n">saml</span><span class="o">/</span><span class="n">metadata</span>
<span class="n">Contact</span> <span class="n">email</span> <span class="n">address</span><span class="p">:</span> <span class="n">lib</span><span class="o">-</span><span class="n">touchstone</span><span class="nd">@mit</span><span class="o">.</span><span class="n">edu</span>
<span class="n">Web</span> <span class="n">server</span> <span class="n">host</span> <span class="n">name</span><span class="p">:</span> <span class="n">YOUR_APP</span><span class="o">.</span><span class="n">mit</span><span class="o">.</span><span class="n">edu</span>
<span class="n">Organization</span> <span class="n">name</span><span class="p">:</span> <span class="n">MIT</span> <span class="n">Libraries</span>
<span class="n">Organization</span> <span class="n">URL</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">libraries</span><span class="o">.</span><span class="n">mit</span><span class="o">.</span><span class="n">edu</span>
</pre></div>
</div>
<p>IS&amp;T’s Touchstone documentation generally assumes you’re running a Shibboleth server, and is confusing for SP applications. Here is some additional information learned in previous back-and-forths with them that may be helpful:</p>
<ul class="simple">
<li><p>They will want to know which SAML attributes your application requires. This is not documented anywhere I could find, but the attributes they typically release are:</p>
<ul>
<li><p>eduPersonPrincipalName (ePPN): used as the unique user ID. Its value is the
user’s Kerberos name, “scoped” to the mit.edu domain, e.g. “username&#64;mit.edu”.</p></li>
<li><p>displayName</p></li>
<li><p>affiliation attributes</p></li>
</ul>
</li>
<li><p>Despite the fact that their documentation says the SP entity ID should be
<code class="docutils literal notranslate"><span class="pre">/shibboleth</span></code>, they do not like that, and would prefer that it be <code class="docutils literal notranslate"><span class="pre">/saml</span></code>, must not have a trailing slash.</p></li>
<li><p>Their IDP does not support Single Logout, so don’t try to configure that.</p></li>
<li><p>They require both a signing and an encryption cert defined in the metadata, but they can be the same.</p></li>
<li><p>The IDP SSO binding must be <code class="docutils literal notranslate"><span class="pre">HTTP-Redirect</span></code>.</p></li>
<li><p>For python3-saml, be sure to set <code class="docutils literal notranslate"><span class="pre">requestedAuthnContext</span></code> to false in settings.json if you want users to be able to choose between password and certificate login methods (otherwise it will default to password-only).</p></li>
</ul>
</section>
<section id="non-touchstone-auth-for-pr-builds-and-local-development">
<h3>Non-touchstone auth for PR builds and local development<a class="headerlink" href="#non-touchstone-auth-for-pr-builds-and-local-development" title="Permalink to this headline">¶</a></h3>
<p>Registering a local SP for Touchstone is probably more trouble than it’s worth.
Using an alternative authentication strategy for local, test and PR builds is
recommended. For Rails apps, we use the <code class="docutils literal notranslate"><span class="pre">developer</span></code> authentication that is include with <code class="docutils literal notranslate"><span class="pre">Devise</span></code>.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">Guides</a></h1>








<h3>Navigation</h3>
<p><span class="caption-text">Start Here</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../basics/a11y.html">Accessibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/github.html">GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../basics/github_desktop.html">GitHub Desktop</a></li>
</ul>
<p><span class="caption-text">How We Work Together</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../collaboration/code_review.html">Code review</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collaboration/pairing.html">Pair programming</a></li>
</ul>
<p><span class="caption-text">Languages and Frameworks</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../languages/python.html">Python Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/rails.html">Rails at MIT Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/vuejs.html">Vue.js at MIT Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../languages/wordpress.html">WordPress at MIT Libraries</a></li>
</ul>
<p><span class="caption-text">Authentication</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="oauth.html">OAuth at MIT (deprecated)</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Touchstone / Shibboleth / SAML</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-touchstone">What is Touchstone?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-is-shibboleth">What is Shibboleth?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-is-saml">What is SAML?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-are-we-doing-here">What are we doing here?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#registering-a-saml-sp-in-mit-touchstone">Registering a SAML SP in MIT Touchstone</a></li>
</ul>
</li>
</ul>
<p><span class="caption-text">Deployment</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../deploy/airflow.html">Airflow: workflow engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/aws-2.0.html">AWS Organization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/cicd.html">Continuous Integration/Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/heroku.html">Heroku</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/heroku_checklist.html">Heroku Launch Checklist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/legacy-aws.html">Legacy AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/legacy-terraform.html">Legacy Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/pantheon.html">Pantheon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../deploy/terraform-1.0.html">Terraform</a></li>
</ul>
<p><span class="caption-text">Everything else</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../misc/adr.html">Architecture Decision Records</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/diagrams.html">Diagramming Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/docker.html">Containerizing Your App</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/exception_monitoring.html">Exception Monitoring</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/incident_response.html">Incident Response Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/logging.html">Central Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/matomo.html">Configuring apps to use Matomo for analytics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/proxy_urls.html">Proxy URLs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/ssl.html">SSL Encryption</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="oauth.html" title="previous chapter">OAuth at MIT (deprecated)</a></li>
      <li>Next: <a href="../deploy/airflow.html" title="next chapter">Airflow: workflow engine</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, MIT Libraries.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/authentication/touchstone_saml.md.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>